services:
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      # Domaine et configuration de base
      - DOMAIN=${NOM_DOMAINE}
      
      # Sécurité - Inscriptions désactivées
      - SIGNUPS_ALLOWED=false
      - SIGNUPS_VERIFY=true
      - INVITATIONS_ALLOWED=true
      - SHOW_PASSWORD_HINT=false
      
      # Admin Token - UTILISE LE SECRET
      - ADMIN_TOKEN_FILE=/run/secrets/admin_token
      
      # Templates et personnalisation
      - TEMPLATES_FOLDER=/data/templates

      - WEBSOCKET_ENABLED=true

    volumes:
      - ./vw-data:/data
      - ./vw-data/images:/web-vault/images  # Pour les logos/favicons personnalisés
    
    networks:
      - vaultwarden-network
    
    secrets:
      - admin_token

  caddy:
    image: caddy:2-alpine
    container_name: caddy-proxy
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DOMAIN=${NOM_DOMAINE}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy-config:/config
      - ./caddy-data:/data
    depends_on:
      - vaultwarden
    networks:
      - vaultwarden-network

  # Service de backup automatique
  backup:
    image: offen/docker-volume-backup:latest
    container_name: vaultwarden-backup
    restart: unless-stopped
    environment:
      # Sauvegarde quotidienne à 2h du matin
      - BACKUP_CRON_EXPRESSION=0 2 * * *
      - BACKUP_FILENAME=vaultwarden-backup-%Y%m%d-%H%M%S.tar.gz
      # Conserver 30 jours de sauvegardes
      - BACKUP_RETENTION_DAYS=30
      - BACKUP_PRUNING_PREFIX=vaultwarden-backup-
    volumes:
      - ./vw-data:/backup/vw-data:ro
      - ./backups:/archive
    networks:
      - vaultwarden-network

networks:
  vaultwarden-network:

secrets:
  admin_token:
    file: ./secrets/admin_token.txt
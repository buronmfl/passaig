version: '3.8'

services:
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      # Domaine et configuration de base
      - DOMAIN=https://bank-ig.lfmn.dgac.aviation
      
      # Sécurité - Inscriptions désactivées
      - SIGNUPS_ALLOWED=false
      - SIGNUPS_VERIFY=true
      - SIGNUPS_DOMAINS_WHITELIST=
      - INVITATIONS_ALLOWED=true  # Permet les invitations par admin uniquement
      - SHOW_PASSWORD_HINT=false
      
      # Admin Token - UTILISE LE SECRET
      - ADMIN_TOKEN_FILE=/run/secrets/admin_token
      
      # Templates et personnalisation
      - TEMPLATES_FOLDER=/data/templates
      
      # Configuration SMTP (à personnaliser selon vos besoins)
      - SMTP_HOST=${SMTP_HOST:-smtp.example.com}
      - SMTP_FROM=${SMTP_FROM:-vaultwarden@example.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_SECURITY=${SMTP_SECURITY:-starttls}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD_FILE=/run/secrets/smtp_password
      
      # Icônes et personnalisation
      - ICON_CACHE_TTL=2592000
      - ICON_CACHE_NEGTTL=259200
      - ICON_DOWNLOAD_TIMEOUT=10
      
      # Performance et limites
      - WEB_VAULT_ENABLED=true
      - WEBSOCKET_ENABLED=true
      - SENDS_ALLOWED=true
      - EMERGENCY_ACCESS_ALLOWED=true
      
      # Logs
      - LOG_LEVEL=info
      - EXTENDED_LOGGING=true
      
    volumes:
      - ./vw-data:/data
      - ./vw-data/images:/web-vault/images  # Pour les logos/favicons personnalisés
      
    secrets:
      - admin_token
      - smtp_password
    
    depends_on:
      - caddy
      
    networks:
      - vaultwarden-network

  caddy:
    image: caddy:2-alpine
    container_name: caddy-proxy
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DOMAIN=https://bank-ig.lfmn.dgac.aviation
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy-data:/data
      - ./caddy-config:/config
    depends_on:
      - vaultwarden
    networks:
      - vaultwarden-network

  # Service de backup automatique
  backup:
    image: offen/docker-volume-backup:latest
    container_name: vaultwarden-backup
    restart: unless-stopped
    environment:
      # Sauvegarde quotidienne à 2h du matin
      - BACKUP_CRON_EXPRESSION=0 2 * * *
      - BACKUP_FILENAME=vaultwarden-backup-%Y%m%d-%H%M%S.tar.gz
      # Conserver 30 jours de sauvegardes
      - BACKUP_RETENTION_DAYS=30
      - BACKUP_PRUNING_PREFIX=vaultwarden-backup-
      # Notifications (optionnel)
      - NOTIFICATION_URLS=${BACKUP_NOTIFICATION_URL:-}
    volumes:
      - ./vw-data:/backup/vw-data:ro
      - ./backups:/archive
    networks:
      - vaultwarden-network

networks:
  vaultwarden-network:
    driver: bridge

secrets:
  admin_token:
    file: ./secrets/admin_token.txt
  smtp_password:
    file: ./secrets/smtp_password.txt